{"ast":null,"code":"import { __extends } from \"tslib\";\nimport { Emitter } from '@segment/analytics-generic-utils';\nimport { backoff } from './backoff';\n/**\n * @internal\n */\nexport var ON_REMOVE_FROM_FUTURE = 'onRemoveFromFuture';\nvar PriorityQueue = /** @class */function (_super) {\n  __extends(PriorityQueue, _super);\n  function PriorityQueue(maxAttempts, queue, seen) {\n    var _this = _super.call(this) || this;\n    _this.future = [];\n    _this.maxAttempts = maxAttempts;\n    _this.queue = queue;\n    _this.seen = seen !== null && seen !== void 0 ? seen : {};\n    return _this;\n  }\n  PriorityQueue.prototype.push = function () {\n    var _this = this;\n    var items = [];\n    for (var _i = 0; _i < arguments.length; _i++) {\n      items[_i] = arguments[_i];\n    }\n    var accepted = items.map(function (operation) {\n      var attempts = _this.updateAttempts(operation);\n      if (attempts > _this.maxAttempts || _this.includes(operation)) {\n        return false;\n      }\n      _this.queue.push(operation);\n      return true;\n    });\n    this.queue = this.queue.sort(function (a, b) {\n      return _this.getAttempts(a) - _this.getAttempts(b);\n    });\n    return accepted;\n  };\n  PriorityQueue.prototype.pushWithBackoff = function (item) {\n    var _this = this;\n    if (this.getAttempts(item) === 0) {\n      return this.push(item)[0];\n    }\n    var attempt = this.updateAttempts(item);\n    if (attempt > this.maxAttempts || this.includes(item)) {\n      return false;\n    }\n    var timeout = backoff({\n      attempt: attempt - 1\n    });\n    setTimeout(function () {\n      _this.queue.push(item);\n      // remove from future list\n      _this.future = _this.future.filter(function (f) {\n        return f.id !== item.id;\n      });\n      // Lets listeners know that a 'future' message is now available in the queue\n      _this.emit(ON_REMOVE_FROM_FUTURE);\n    }, timeout);\n    this.future.push(item);\n    return true;\n  };\n  PriorityQueue.prototype.getAttempts = function (item) {\n    var _a;\n    return (_a = this.seen[item.id]) !== null && _a !== void 0 ? _a : 0;\n  };\n  PriorityQueue.prototype.updateAttempts = function (item) {\n    this.seen[item.id] = this.getAttempts(item) + 1;\n    return this.getAttempts(item);\n  };\n  PriorityQueue.prototype.includes = function (item) {\n    return this.queue.includes(item) || this.future.includes(item) || Boolean(this.queue.find(function (i) {\n      return i.id === item.id;\n    })) || Boolean(this.future.find(function (i) {\n      return i.id === item.id;\n    }));\n  };\n  PriorityQueue.prototype.pop = function () {\n    return this.queue.shift();\n  };\n  Object.defineProperty(PriorityQueue.prototype, \"length\", {\n    get: function () {\n      return this.queue.length;\n    },\n    enumerable: false,\n    configurable: true\n  });\n  Object.defineProperty(PriorityQueue.prototype, \"todo\", {\n    get: function () {\n      return this.queue.length + this.future.length;\n    },\n    enumerable: false,\n    configurable: true\n  });\n  return PriorityQueue;\n}(Emitter);\nexport { PriorityQueue };","map":{"version":3,"names":["Emitter","backoff","ON_REMOVE_FROM_FUTURE","PriorityQueue","_super","__extends","maxAttempts","queue","seen","_this","call","future","prototype","push","items","_i","arguments","length","accepted","map","operation","attempts","updateAttempts","includes","sort","a","b","getAttempts","pushWithBackoff","item","attempt","timeout","setTimeout","filter","f","id","emit","_a","Boolean","find","i","pop","shift","Object","defineProperty","get"],"sources":["/Users/bcaudillo/Desktop/Projects/todo/node_modules/@segment/analytics-core/src/priority-queue/index.ts"],"sourcesContent":["import { Emitter } from '@segment/analytics-generic-utils'\nimport { backoff } from './backoff'\n\n/**\n * @internal\n */\nexport const ON_REMOVE_FROM_FUTURE = 'onRemoveFromFuture'\n\ninterface QueueItem {\n  id: string\n}\n\nexport class PriorityQueue<Item extends QueueItem = QueueItem> extends Emitter {\n  protected future: Item[] = []\n  protected queue: Item[]\n  protected seen: Record<string, number>\n\n  public maxAttempts: number\n\n  constructor(\n    maxAttempts: number,\n    queue: Item[],\n    seen?: Record<string, number>\n  ) {\n    super()\n    this.maxAttempts = maxAttempts\n    this.queue = queue\n    this.seen = seen ?? {}\n  }\n\n  push(...items: Item[]): boolean[] {\n    const accepted = items.map((operation) => {\n      const attempts = this.updateAttempts(operation)\n\n      if (attempts > this.maxAttempts || this.includes(operation)) {\n        return false\n      }\n\n      this.queue.push(operation)\n      return true\n    })\n\n    this.queue = this.queue.sort(\n      (a, b) => this.getAttempts(a) - this.getAttempts(b)\n    )\n    return accepted\n  }\n\n  pushWithBackoff(item: Item): boolean {\n    if (this.getAttempts(item) === 0) {\n      return this.push(item)[0]\n    }\n\n    const attempt = this.updateAttempts(item)\n\n    if (attempt > this.maxAttempts || this.includes(item)) {\n      return false\n    }\n\n    const timeout = backoff({ attempt: attempt - 1 })\n\n    setTimeout(() => {\n      this.queue.push(item)\n      // remove from future list\n      this.future = this.future.filter((f) => f.id !== item.id)\n      // Lets listeners know that a 'future' message is now available in the queue\n      this.emit(ON_REMOVE_FROM_FUTURE)\n    }, timeout)\n\n    this.future.push(item)\n    return true\n  }\n\n  public getAttempts(item: Item): number {\n    return this.seen[item.id] ?? 0\n  }\n\n  public updateAttempts(item: Item): number {\n    this.seen[item.id] = this.getAttempts(item) + 1\n    return this.getAttempts(item)\n  }\n\n  includes(item: Item): boolean {\n    return (\n      this.queue.includes(item) ||\n      this.future.includes(item) ||\n      Boolean(this.queue.find((i) => i.id === item.id)) ||\n      Boolean(this.future.find((i) => i.id === item.id))\n    )\n  }\n\n  pop(): Item | undefined {\n    return this.queue.shift()\n  }\n\n  public get length(): number {\n    return this.queue.length\n  }\n\n  public get todo(): number {\n    return this.queue.length + this.future.length\n  }\n}\n"],"mappings":";AAAA,SAASA,OAAO,QAAQ,kCAAkC;AAC1D,SAASC,OAAO,QAAQ,WAAW;AAEnC;;;AAGA,OAAO,IAAMC,qBAAqB,GAAG,oBAAoB;AAMzD,IAAAC,aAAA,0BAAAC,MAAA;EAAuEC,SAAA,CAAAF,aAAA,EAAAC,MAAA;EAOrE,SAAAD,cACEG,WAAmB,EACnBC,KAAa,EACbC,IAA6B;IAH/B,IAAAC,KAAA,GAKEL,MAAA,CAAAM,IAAA,MAAO;IAXCD,KAAA,CAAAE,MAAM,GAAW,EAAE;IAY3BF,KAAI,CAACH,WAAW,GAAGA,WAAW;IAC9BG,KAAI,CAACF,KAAK,GAAGA,KAAK;IAClBE,KAAI,CAACD,IAAI,GAAGA,IAAI,aAAJA,IAAI,cAAJA,IAAI,GAAI,EAAE;;EACxB;EAEAL,aAAA,CAAAS,SAAA,CAAAC,IAAI,GAAJ;IAAA,IAAAJ,KAAA;IAAK,IAAAK,KAAA;SAAA,IAAAC,EAAA,IAAgB,EAAhBA,EAAA,GAAAC,SAAA,CAAAC,MAAgB,EAAhBF,EAAA,EAAgB;MAAhBD,KAAA,CAAAC,EAAA,IAAAC,SAAA,CAAAD,EAAA;;IACH,IAAMG,QAAQ,GAAGJ,KAAK,CAACK,GAAG,CAAC,UAACC,SAAS;MACnC,IAAMC,QAAQ,GAAGZ,KAAI,CAACa,cAAc,CAACF,SAAS,CAAC;MAE/C,IAAIC,QAAQ,GAAGZ,KAAI,CAACH,WAAW,IAAIG,KAAI,CAACc,QAAQ,CAACH,SAAS,CAAC,EAAE;QAC3D,OAAO,KAAK;;MAGdX,KAAI,CAACF,KAAK,CAACM,IAAI,CAACO,SAAS,CAAC;MAC1B,OAAO,IAAI;IACb,CAAC,CAAC;IAEF,IAAI,CAACb,KAAK,GAAG,IAAI,CAACA,KAAK,CAACiB,IAAI,CAC1B,UAACC,CAAC,EAAEC,CAAC;MAAK,OAAAjB,KAAI,CAACkB,WAAW,CAACF,CAAC,CAAC,GAAGhB,KAAI,CAACkB,WAAW,CAACD,CAAC,CAAC;IAAzC,CAAyC,CACpD;IACD,OAAOR,QAAQ;EACjB,CAAC;EAEDf,aAAA,CAAAS,SAAA,CAAAgB,eAAe,GAAf,UAAgBC,IAAU;IAA1B,IAAApB,KAAA;IACE,IAAI,IAAI,CAACkB,WAAW,CAACE,IAAI,CAAC,KAAK,CAAC,EAAE;MAChC,OAAO,IAAI,CAAChB,IAAI,CAACgB,IAAI,CAAC,CAAC,CAAC,CAAC;;IAG3B,IAAMC,OAAO,GAAG,IAAI,CAACR,cAAc,CAACO,IAAI,CAAC;IAEzC,IAAIC,OAAO,GAAG,IAAI,CAACxB,WAAW,IAAI,IAAI,CAACiB,QAAQ,CAACM,IAAI,CAAC,EAAE;MACrD,OAAO,KAAK;;IAGd,IAAME,OAAO,GAAG9B,OAAO,CAAC;MAAE6B,OAAO,EAAEA,OAAO,GAAG;IAAC,CAAE,CAAC;IAEjDE,UAAU,CAAC;MACTvB,KAAI,CAACF,KAAK,CAACM,IAAI,CAACgB,IAAI,CAAC;MACrB;MACApB,KAAI,CAACE,MAAM,GAAGF,KAAI,CAACE,MAAM,CAACsB,MAAM,CAAC,UAACC,CAAC;QAAK,OAAAA,CAAC,CAACC,EAAE,KAAKN,IAAI,CAACM,EAAE;MAAhB,CAAgB,CAAC;MACzD;MACA1B,KAAI,CAAC2B,IAAI,CAAClC,qBAAqB,CAAC;IAClC,CAAC,EAAE6B,OAAO,CAAC;IAEX,IAAI,CAACpB,MAAM,CAACE,IAAI,CAACgB,IAAI,CAAC;IACtB,OAAO,IAAI;EACb,CAAC;EAEM1B,aAAA,CAAAS,SAAA,CAAAe,WAAW,GAAlB,UAAmBE,IAAU;;IAC3B,OAAO,CAAAQ,EAAA,OAAI,CAAC7B,IAAI,CAACqB,IAAI,CAACM,EAAE,CAAC,cAAAE,EAAA,cAAAA,EAAA,GAAI,CAAC;EAChC,CAAC;EAEMlC,aAAA,CAAAS,SAAA,CAAAU,cAAc,GAArB,UAAsBO,IAAU;IAC9B,IAAI,CAACrB,IAAI,CAACqB,IAAI,CAACM,EAAE,CAAC,GAAG,IAAI,CAACR,WAAW,CAACE,IAAI,CAAC,GAAG,CAAC;IAC/C,OAAO,IAAI,CAACF,WAAW,CAACE,IAAI,CAAC;EAC/B,CAAC;EAED1B,aAAA,CAAAS,SAAA,CAAAW,QAAQ,GAAR,UAASM,IAAU;IACjB,OACE,IAAI,CAACtB,KAAK,CAACgB,QAAQ,CAACM,IAAI,CAAC,IACzB,IAAI,CAAClB,MAAM,CAACY,QAAQ,CAACM,IAAI,CAAC,IAC1BS,OAAO,CAAC,IAAI,CAAC/B,KAAK,CAACgC,IAAI,CAAC,UAACC,CAAC;MAAK,OAAAA,CAAC,CAACL,EAAE,KAAKN,IAAI,CAACM,EAAE;IAAhB,CAAgB,CAAC,CAAC,IACjDG,OAAO,CAAC,IAAI,CAAC3B,MAAM,CAAC4B,IAAI,CAAC,UAACC,CAAC;MAAK,OAAAA,CAAC,CAACL,EAAE,KAAKN,IAAI,CAACM,EAAE;IAAhB,CAAgB,CAAC,CAAC;EAEtD,CAAC;EAEDhC,aAAA,CAAAS,SAAA,CAAA6B,GAAG,GAAH;IACE,OAAO,IAAI,CAAClC,KAAK,CAACmC,KAAK,EAAE;EAC3B,CAAC;EAEDC,MAAA,CAAAC,cAAA,CAAWzC,aAAA,CAAAS,SAAA,UAAM;SAAjB,SAAAiC,CAAA;MACE,OAAO,IAAI,CAACtC,KAAK,CAACU,MAAM;IAC1B,CAAC;;;;EAED0B,MAAA,CAAAC,cAAA,CAAWzC,aAAA,CAAAS,SAAA,QAAI;SAAf,SAAAiC,CAAA;MACE,OAAO,IAAI,CAACtC,KAAK,CAACU,MAAM,GAAG,IAAI,CAACN,MAAM,CAACM,MAAM;IAC/C,CAAC;;;;EACH,OAAAd,aAAC;AAAD,CAAC,CA1FsEH,OAAO","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}