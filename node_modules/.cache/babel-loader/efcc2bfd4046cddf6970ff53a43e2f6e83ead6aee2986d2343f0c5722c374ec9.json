{"ast":null,"code":"import { v4 as uuid } from '@lukeed/uuid';\nimport { dset } from 'dset';\nimport { CoreLogger } from '../logger';\nimport { NullStats } from '../stats';\nvar ContextCancelation = /** @class */function () {\n  function ContextCancelation(options) {\n    var _a, _b, _c;\n    this.retry = (_a = options.retry) !== null && _a !== void 0 ? _a : true;\n    this.type = (_b = options.type) !== null && _b !== void 0 ? _b : 'plugin Error';\n    this.reason = (_c = options.reason) !== null && _c !== void 0 ? _c : '';\n  }\n  return ContextCancelation;\n}();\nexport { ContextCancelation };\nvar CoreContext = /** @class */function () {\n  function CoreContext(event, id, stats, logger) {\n    if (id === void 0) {\n      id = uuid();\n    }\n    if (stats === void 0) {\n      stats = new NullStats();\n    }\n    if (logger === void 0) {\n      logger = new CoreLogger();\n    }\n    this.attempts = 0;\n    this.event = event;\n    this._id = id;\n    this.logger = logger;\n    this.stats = stats;\n  }\n  CoreContext.system = function () {\n    // This should be overridden by the subclass to return an instance of the subclass.\n  };\n  CoreContext.prototype.isSame = function (other) {\n    return other.id === this.id;\n  };\n  CoreContext.prototype.cancel = function (error) {\n    if (error) {\n      throw error;\n    }\n    throw new ContextCancelation({\n      reason: 'Context Cancel'\n    });\n  };\n  CoreContext.prototype.log = function (level, message, extras) {\n    this.logger.log(level, message, extras);\n  };\n  Object.defineProperty(CoreContext.prototype, \"id\", {\n    get: function () {\n      return this._id;\n    },\n    enumerable: false,\n    configurable: true\n  });\n  CoreContext.prototype.updateEvent = function (path, val) {\n    var _a;\n    // Don't allow integrations that are set to false to be overwritten with integration settings.\n    if (path.split('.')[0] === 'integrations') {\n      var integrationName = path.split('.')[1];\n      if (((_a = this.event.integrations) === null || _a === void 0 ? void 0 : _a[integrationName]) === false) {\n        return this.event;\n      }\n    }\n    dset(this.event, path, val);\n    return this.event;\n  };\n  CoreContext.prototype.failedDelivery = function () {\n    return this._failedDelivery;\n  };\n  CoreContext.prototype.setFailedDelivery = function (options) {\n    this._failedDelivery = options;\n  };\n  CoreContext.prototype.logs = function () {\n    return this.logger.logs;\n  };\n  CoreContext.prototype.flush = function () {\n    this.logger.flush();\n    this.stats.flush();\n  };\n  CoreContext.prototype.toJSON = function () {\n    return {\n      id: this._id,\n      event: this.event,\n      logs: this.logger.logs,\n      metrics: this.stats.metrics\n    };\n  };\n  return CoreContext;\n}();\nexport { CoreContext };","map":{"version":3,"names":["v4","uuid","dset","CoreLogger","NullStats","ContextCancelation","options","retry","_a","type","_b","reason","_c","CoreContext","event","id","stats","logger","attempts","_id","system","prototype","isSame","other","cancel","error","log","level","message","extras","Object","defineProperty","get","updateEvent","path","val","split","integrationName","integrations","failedDelivery","_failedDelivery","setFailedDelivery","logs","flush","toJSON","metrics"],"sources":["/Users/bcaudillo/Desktop/Projects/todo/node_modules/@segment/analytics-core/src/context/index.ts"],"sourcesContent":["import { CoreSegmentEvent } from '../events/interfaces'\n\nimport { v4 as uuid } from '@lukeed/uuid'\nimport { dset } from 'dset'\nimport { CoreLogger, LogLevel, LogMessage } from '../logger'\nimport { CoreStats, CoreMetric, NullStats } from '../stats'\n\nexport interface SerializedContext {\n  id: string\n  event: CoreSegmentEvent\n  logs: LogMessage[]\n  metrics?: CoreMetric[]\n}\n\nexport interface ContextFailedDelivery {\n  reason: unknown\n}\n\nexport interface CancelationOptions {\n  retry?: boolean\n  reason?: string\n  type?: string\n}\n\nexport class ContextCancelation {\n  retry: boolean\n  type: string\n  reason?: string\n\n  constructor(options: CancelationOptions) {\n    this.retry = options.retry ?? true\n    this.type = options.type ?? 'plugin Error'\n    this.reason = options.reason ?? ''\n  }\n}\n\nexport abstract class CoreContext<\n  Event extends CoreSegmentEvent = CoreSegmentEvent\n> {\n  event: Event\n  logger: CoreLogger\n  stats: CoreStats\n  attempts = 0\n\n  private _failedDelivery?: ContextFailedDelivery\n  private _id: string\n\n  constructor(\n    event: Event,\n    id = uuid(),\n    stats: CoreStats = new NullStats(),\n    logger = new CoreLogger()\n  ) {\n    this.event = event\n    this._id = id\n    this.logger = logger\n    this.stats = stats\n  }\n\n  static system(): void {\n    // This should be overridden by the subclass to return an instance of the subclass.\n  }\n\n  isSame(other: CoreContext): boolean {\n    return other.id === this.id\n  }\n\n  cancel(error?: Error | ContextCancelation): never {\n    if (error) {\n      throw error\n    }\n\n    throw new ContextCancelation({ reason: 'Context Cancel' })\n  }\n\n  log(level: LogLevel, message: string, extras?: object): void {\n    this.logger.log(level, message, extras)\n  }\n\n  get id(): string {\n    return this._id\n  }\n\n  updateEvent(path: string, val: unknown): Event {\n    // Don't allow integrations that are set to false to be overwritten with integration settings.\n    if (path.split('.')[0] === 'integrations') {\n      const integrationName = path.split('.')[1]\n\n      if (this.event.integrations?.[integrationName] === false) {\n        return this.event\n      }\n    }\n\n    dset(this.event, path, val)\n    return this.event\n  }\n\n  failedDelivery(): ContextFailedDelivery | undefined {\n    return this._failedDelivery\n  }\n\n  setFailedDelivery(options: ContextFailedDelivery) {\n    this._failedDelivery = options\n  }\n\n  logs(): LogMessage[] {\n    return this.logger.logs\n  }\n\n  flush(): void {\n    this.logger.flush()\n    this.stats.flush()\n  }\n\n  toJSON(): SerializedContext {\n    return {\n      id: this._id,\n      event: this.event,\n      logs: this.logger.logs,\n      metrics: this.stats.metrics,\n    }\n  }\n}\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}